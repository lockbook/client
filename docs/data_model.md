# Data Model
## Backend
The backend tracks all data for all users. This includes user information and file metadata on a PostgreSQL database we call `IndexDB` and file contents on a DigitalOcean S3 bucket we call `FilesDB`. The server uses IndexDB to help clients sync file metadata and know when to sync file contents. The server uses FilesDB to store file contents only. Clients access FilesDB directly to read files (no authentication required because they're encrypted) but writes go through the server, which verifies users' permissions first.

As an S3 datastore, FilesDB is essentially a map from `file_id` to `file_content`. Each Lockbook file is an S3 file with `file_id` as the file name (no extension) and base64-encoded encrypted `file_content` as the only file contents.

IndexDB contains 3 tables. `users` stores users' usernames and public keys. `files` stores file names and versions. `permissions` stores which users have access to which files.

`users`:
* `username`: unique SHA1-hashed username; used for users locate each other to share content
* `pub_key_n`: modulus of user's RSA public key; used to authenticate users
* `pub_key_e`: exponent of user's RSA public key; used to authenticate users

`files`:
* `file_id`: UUID used to identify files (generated by client)
* `file_name`: base64-encoded encrypted file name; used as user-agnostic human-readable display name
* `file_content_version`: unix timestamp of last file content update (generated by database); used to detect edit conflicts
* `deleted`: whether the file is deleted; used to sync deletions across devices

`permissions`:
* `username`: SHA1-hashed username; indicates permissioned user
* `file_path`: base64-encoded encrypted file path; lets users organize files independently
* `file_id`: UUID (generated by client); indicates permissioned file
* `file_metadata_version`: unix timestamp of last metadata update (generated by database); used to determine which files a client needs to update
* `permission_type`: type of permission, currently always `owner` but will eventually include `read` and `write`

## Clients
Clients track file data for a single user. This includes the file metadata `file_id`, `file_path`, `file_name`, `file_content_version`, `file_metadata_version`, and `deleted`, as well as the file contents themselves (if synced for offline editing). In addition, clients track a single global `last_updated_version`. Clients use versions to sync metadata and detect edit conflicts.

# Usage
+ [File Sync](sync.md)
+ [File and Folder Sharing](files_folders_and_sharing.md)