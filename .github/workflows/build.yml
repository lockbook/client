name: Build

on:
  push:
    branches: [ master ]
    paths-ignore:
      - docs/**
  pull_request:
    branches: [ master ]

jobs:
  Core:
    runs-on: ubuntu-latest
    env:
      LOCKBOOK_API_LOCATION: http://lockbook.app:8000
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN}}
      BRANCH: ${{ github.head_ref }}
    steps:
    - uses: actions/checkout@v2
    - name: Login
      run: docker login docker.pkg.github.com -u Github_Actions -p $GH_TOKEN
    - name: Pull older image for cache
      run: make core_pull
    - name: Build container
      run: make core_cached
    - name: Lint
      run: make core_lint
    - name: Compile and run tests
      run: make core_test
    - name: Check Formatting
      run: make core_fmt
    - name: Publish container
      run: make core_push
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: Build Core - ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
  Server:
    runs-on: ubuntu-latest
    env:
      INDEX_DB_CONFIG_USER: ${{ secrets.INDEX_DB_CONFIG_USER }}
      INDEX_DB_CONFIG_PASS: ${{ secrets.INDEX_DB_CONFIG_PASS }}
      INDEX_DB_CONFIG_HOST: ${{ secrets.INDEX_DB_CONFIG_HOST }}
      INDEX_DB_CONFIG_PORT: ${{ secrets.INDEX_DB_CONFIG_PORT }}
      INDEX_DB_CONFIG_DB: ${{ secrets.INDEX_DB_CONFIG_DB }}
      INDEX_DB_CONFIG_CERT: ${{ secrets.INDEX_DB_CONFIG_CERT }}
      FILES_DB_CONFIG_BUCKET: ${{ secrets.FILES_DB_CONFIG_BUCKET }}
      FILES_DB_CONFIG_REGION: ${{ secrets.FILES_DB_CONFIG_REGION }}
      FILES_DB_CONFIG_ACCESS_KEY: ${{ secrets.FILES_DB_CONFIG_ACCESS_KEY }}
      FILES_DB_CONFIG_SECRET_KEY: ${{ secrets.FILES_DB_CONFIG_SECRET_KEY }}
      MAX_AUTH_DELAY: 100000
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN}}
      BRANCH: ${{ github.head_ref }}
    steps:
    - uses: actions/checkout@v2
    - name: Login
      run: docker login docker.pkg.github.com -u Github_Actions -p $GH_TOKEN
    - name: Pull older image for cache
      run: make server_pull
    - name: Build container
      run: make server_cached
    - name: Lint
      run: make server_lint
    - name: Compile and run tests
      run: make server_test
    - name: Check Formatting
      run: make server_fmt
    - name: Publish container
      run: make server_push
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: Build Server - ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
  Cli:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN}}
      BRANCH: ${{ github.head_ref }}
    steps:
    - uses: actions/checkout@v2
    - name: Login
      run: docker login docker.pkg.github.com -u Github_Actions -p $GH_TOKEN
    - name: Pull older image for cache
      run: make cli_pull
    - name: Build container
      run: make cli_cached
    - name: Lint
      run: make cli_lint
    - name: Compile and run tests
      run: make cli_test
    - name: Check Formatting
      run: make cli_fmt
    - name: Publish container
      run: make cli_push
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: Build Cli - ${{ job.status }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
